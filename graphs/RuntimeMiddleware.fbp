# @runtime noflo-browser
# @icon cogs
INPORT=Dispatch.IN:IN
OUTPORT=Passed.OUT:PASS
OUTPORT=NewActions.OUT:NEW

'runtime:open,storage:opened,context:edges,project:fromruntime,storage:ready,storage:stored:runtime,runtime:start,runtime:stop,runtime:reconnect,runtime:sendComponent' -> ROUTES Dispatch(ui/DispatchAction)
Dispatch PASS -> IN Passed(core/Merge)

# New actions generated by this middleware
'storage:save:project' -> ACTION ProjectSaveAction(ui/SetAction) OUT -> IN NewActions(core/Merge)
'storage:save:graph' -> ACTION GraphSaveAction(ui/SetAction) OUT -> IN NewActions
'storage:save:component' -> ACTION ComponentSaveAction(ui/SetAction) OUT -> IN NewActions
'flowhub:runtimes:register' -> ACTION RuntimeRegisterAction(ui/SetAction) OUT -> IN NewActions
'storage:save:runtime' -> ACTION RuntimeSaveAction(ui/SetAction) OUT -> IN NewActions
'runtime:error' -> ACTION RuntimeErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:opened' -> ACTION RuntimeOpenedAction(ui/SetAction) OUT -> IN NewActions
'runtime:opening' -> ACTION RuntimeOpeningAction(ui/SetAction) OUT -> IN NewActions
'runtime:status' -> ACTION RuntimeStatusAction(ui/SetAction) OUT -> IN NewActions
'runtime:components' -> ACTION RuntimeComponentsAction(ui/SetAction) OUT -> IN NewActions
'runtime:component' -> ACTION RuntimeComponentAction(ui/SetAction) OUT -> IN NewActions
'runtime:started' -> ACTION RuntimeStartedAction(ui/SetAction) OUT -> IN NewActions
'runtime:stopped' -> ACTION RuntimeStoppedAction(ui/SetAction) OUT -> IN NewActions
'runtime:packet' -> ACTION RuntimePacketAction(ui/SetAction) OUT -> IN NewActions
'runtime:icon' -> ACTION RuntimeIconAction(ui/SetAction) OUT -> IN NewActions
'runtime:output' -> ACTION RuntimeOutputAction(ui/SetAction) OUT -> IN NewActions
'runtime:networkerror' -> ACTION RuntimeNetworkErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:processerror' -> ACTION RuntimeProcessErrorAction(ui/SetAction) OUT -> IN NewActions
'runtime:protocolerror' -> ACTION RuntimeProtocolErrorAction(ui/SetAction) OUT -> IN NewActions
'application:recreatestate' -> ACTION ApplicationRecreateAction(ui/SetAction) OUT -> IN NewActions
'storage:opened' -> ACTION StorageOpenedAction(ui/SetAction) OUT -> IN Passed
'context:edges' -> ACTION ContextEdgesAction(ui/SetAction) OUT -> IN Passed

# Open runtime in live mode
'runtimes' -> KEYS GetRuntimesState(ui/GetActionValues)
Dispatch HANDLE[0] -> IN GetRuntimesState
GetRuntimesState VALUES[0] -> RUNTIMES PopulateRuntimeData(ui/PopulateRuntimeData)
GetRuntimesState OUT -> IN PopulateRuntimeData
PopulateRuntimeData OUT -> IN[0] GetClient
PopulateRuntimeData OUT -> IN RuntimeOpeningAction
PopulateRuntimeData NEW -> UPDATED GetClient
PopulateRuntimeData NEW -> IN RuntimeSaveAction
PopulateRuntimeData ERROR -> IN RuntimeErrorAction
GetClient OUT[0] -> IN OpenLiveMode(ui/OpenLiveMode)
GetClient CLIENT[0] -> CLIENT OpenLiveMode
OpenLiveMode OUT -> IN RuntimeOpenedAction
OpenLiveMode ERROR -> IN RuntimeErrorAction

# Connect runtime associated with project, if any
'runtimes' -> KEYS GetProjectRuntimesState(ui/GetActionValues)
Dispatch HANDLE[1] -> IN GetProjectRuntimesState
GetProjectRuntimesState VALUES[0] -> RUNTIMES PopulateProjectRuntime(ui/PopulateProjectRuntime)
GetProjectRuntimesState OUT -> IN PopulateProjectRuntime
PopulateProjectRuntime OUT -> IN[1] GetClient
PopulateProjectRuntime SKIPPED -> IN StorageOpenedAction
GetClient OUT[1] -> IN OpenProjectMode(ui/OpenProjectMode)
GetClient CLIENT[1] -> CLIENT OpenProjectMode
OpenProjectMode OUT -> IN StorageOpenedAction
OpenProjectMode ERROR -> IN RuntimeErrorAction

# Send selected edges to runtime
'graphs' -> KEYS GetEdgeState(ui/GetActionValues)
Dispatch HANDLE[2] -> IN HasEdgeRuntime(ui/HasActionRuntime)
HasEdgeRuntime OUT -> IN GetEdgeState
# If there is no runtime we don't send edges
HasEdgeRuntime MISSED -> IN Passed
GetEdgeState STATE -> IN[2] GetClient
GetClient CLIENT[2] -> CLIENT SendEdges(ui/SendEdges)
GetEdgeState VALUES[0] -> GRAPHS SendEdges
GetEdgeState OUT -> EDGES SendEdges
SendEdges OUT -> IN ContextEdgesAction
SendEdges ERROR -> IN RuntimeErrorAction

# Create a project based on data on runtime side
Dispatch HANDLE[3] -> IN RuntimeToProject(ui/RuntimeToProject)
RuntimeToProject PROJECT -> IN ProjectSaveAction
RuntimeToProject GRAPH -> IN GraphSaveAction
RuntimeToProject COMPONENT -> IN ComponentSaveAction
RuntimeToProject RUNTIME -> IN RuntimeRegisterAction
RuntimeToProject ERROR -> IN RuntimeErrorAction

# Populate local runtimes
'runtimes' -> KEYS GetStoredRuntimes(ui/GetActionValues)
Dispatch HANDLE[4] -> IN GetStoredRuntimes
GetStoredRuntimes VALUES[0] -> IN EnsureLocalRuntimes(ui/EnsureLocalRuntimes)
EnsureLocalRuntimes OUT -> IN RuntimeSaveAction
EnsureLocalRuntimes RUNTIMES -> INITIAL GetClient(ui/GetRuntimeClient)
GetClient ERROR -> IN RuntimeErrorAction

# Listen for runtime changes
GetClient INSTANCE -> IN ListenRuntime(ui/ListenRuntime)
ListenRuntime RUNTIMEUPDATE -> IN RuntimeRegisterAction
ListenRuntime STATUS -> IN RuntimeStatusAction
ListenRuntime COMPONENTS -> IN RuntimeComponentsAction
ListenRuntime COMPONENT -> IN RuntimeComponentAction
ListenRuntime STARTED -> IN RuntimeStartedAction
ListenRuntime STOPPED -> IN RuntimeStoppedAction
ListenRuntime PACKET -> IN RuntimePacketAction
ListenRuntime ICON -> IN RuntimeIconAction
ListenRuntime OUTPUT -> IN RuntimeOutputAction
ListenRuntime NETWORKERROR -> IN RuntimeNetworkErrorAction
ListenRuntime PROCESSERROR -> IN RuntimeProcessErrorAction
ListenRuntime PROTOCOLERROR -> IN RuntimeProtocolErrorAction
ListenRuntime ERROR -> IN RuntimeErrorAction

# Update fbp-clients based on new runtime information
Dispatch HANDLE[5] -> UPDATED GetClient
GetClient UPDATED -> IN Passed

# Control network start
Dispatch HANDLE[6] -> IN GetStartValues(ui/GetActionValues)
GetStartValues OUT -> IN[3] GetClient
GetClient OUT[3] -> IN StartNetwork(ui/StartNetwork)
GetClient CLIENT[3] -> CLIENT StartNetwork
StartNetwork OUT -> IN RuntimeStartedAction
StartNetwork ERROR -> IN RuntimeErrorAction

# Control network stop
Dispatch HANDLE[7] -> IN GetStopValues(ui/GetActionValues)
GetStopValues OUT -> IN[4] GetClient
GetClient OUT[4] -> IN StopNetwork(ui/StopNetwork)
GetClient CLIENT[4] -> CLIENT StopNetwork
StopNetwork OUT -> IN RuntimeStoppedAction
StopNetwork ERROR -> IN RuntimeErrorAction

# Runtime reconnection
Dispatch HANDLE[8] -> IN GetReconnectValues(ui/GetActionValues)
GetReconnectValues OUT -> IN[5] GetClient
GetClient OUT[5] -> IN ReconnectRuntime(ui/ReconnectRuntime)
GetClient CLIENT[5] -> CLIENT ReconnectRuntime
ReconnectRuntime OUT -> IN ApplicationRecreateAction
ReconnectRuntime ERROR -> IN RuntimeErrorAction

# Sending component changes to runtime
'project' -> KEYS GetComponentValues(ui/GetActionValues)
Dispatch HANDLE[9] -> IN GetComponentValues
GetComponentValues OUT -> IN[6] GetClient
GetClient OUT[6] -> IN SendComponentChanges(ui/SendComponentChanges)
GetClient CLIENT[6] -> CLIENT SendComponentChanges
GetComponentValues VALUES[0] -> PROJECT SendComponentChanges
SendComponentChanges OUT -> IN RuntimeComponentAction
SendComponentChanges ERROR -> IN RuntimeErrorAction
